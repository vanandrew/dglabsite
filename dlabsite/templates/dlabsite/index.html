{% extends "dlabsite/base.html" %}
{% load staticfiles %}

{% block head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/pace.min.js"></script>
<link href="{% static 'dlabsite/css/pace-theme-center-circle.min.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="grid-x">
    <div class="cell medium-12 large-12">
        <div class="grid-y grid-frame align-center-middle primary main-block" style="height:100vh;width:100vw;background:#BFD8D2;">
            <div class="grid-container fluid canvas-container grid-frame"></div>
            <div id="rotator" style="height:100px;width:100px"></div>
            <div style="position:absolute; z-index:100; bottom:5%; right:5%;">
                <h4 class="region-display"></h4>
            </div>
            <div style="position:absolute; z-index:100; bottom:5%; left:5%;">
                <p class="title-text" style="font-size:8vmin;">greene lab</p>
                <a id="interact" class="button custom" style="font-size:3vmin;">interact</a>
            </div>
        </div>
    </div>
</div>
<div class="grid-x">
    <div class="cell medium-12 large-6">
        <div class="grid-y grid-frame align-center-middle text-center primary" style="height:100vh;background:#F4F4F4;">
            <h1><a style="color: black;" href="{% url 'dlabsite:people' %}">lab members</a></h1>
        </div>
    </div>
    <div class="cell medium-12 large-6">
        <div class="grid-y grid-frame align-center-middle text-center" style="height:100vh;background:#DCB239;">
            <h1><a style="color: black;" href="{% url 'dlabsite:research' %}">research</a></h1>
        </div>
    </div>
</div>
<div class="grid-x">
    <div class="cell medium-12 large-6">
        <div class="grid-y grid-frame align-center-middle text-center" style="height:100vh;background:#FEDCD2;">
            <h1><a style="color: black;" href="{% url 'dlabsite:publications' %}">publications</a></h1>
        </div>
    </div>
    <div class="cell medium-12 large-6">
        <div class="grid-y grid-frame align-center-middle text-center" style="height:100vh;background:#DF744A;">
            <h1><a style="color: black;" href="{% url 'dlabsite:data' %}">data/software</a></h1>
        </div>
    </div>
</div>
<div class="grid-x">
    <div class="cell medium-12 large-6">
        <div class="grid-y grid-frame align-center-middle text-center" style="height:100vh;background:#77C9D4;">
            <h1><a style="color: black;" href="{% url 'dlabsite:directions' %}">directions</a></h1>
        </div>
    </div>
    <div class="cell medium-12 large-6">
        <div class="grid-y grid-frame align-center-middle text-center" style="height:100vh;background:#4484CE;">
            <h1><a style="color: black;" href="https://dosenbachlab.wustl.edu/wiki/">wiki</a></h1>
        </div>
    </div>
</div>
<div class="grid-x">
    <div class="cell medium-12 large-12">
        <div class="grid-y grid-frame align-center-middle text-center" style="height:100vh;background:#DCC7AA;">
            <h1><a style="color: black;" href="{% url 'dlabsite:contact' %}">contact</a></h1>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Javascript -->
<script
  src="https://code.jquery.com/jquery-3.2.1.min.js"
  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
  crossorigin="anonymous"></script>
<script src="{% static 'dlabsite/js/foundation.js' %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/92/three.min.js"></script>
<script src="{% static 'dlabsite/js/OrbitControls.js' %}"></script>
<script src="{% static 'dlabsite/js/colordict.js' %}"></script>
<script>

// Setup renderer
var renderer = new THREE.WebGLRenderer();
renderer.setSize($('.main-block').width(),$('.main-block').height());
$('.main-block').append(renderer.domElement);

// Setup scene
var scene = new THREE.Scene();
scene.background = new THREE.Color(0xBFD8D2);

// Setup lighting
var light = new THREE.PointLight(0xffffff,1,800);
light.position.set(0,300,0);
scene.add(light);
var light = new THREE.PointLight(0xffffff,1,800);
light.position.set(300,0,0);
scene.add(light);
var light = new THREE.PointLight(0xffffff,1,800);
light.position.set(0,0,300);
scene.add(light);
var light = new THREE.PointLight(0xffffff,1,800);
light.position.set(0,-300,0);
scene.add(light);
var light = new THREE.PointLight(0xffffff,1,800);
light.position.set(-300,0,0);
scene.add(light);
var light = new THREE.PointLight(0xffffff,1,800);
light.position.set(0,0,-300);
scene.add(light);

// Setup camera
var camera = new THREE.PerspectiveCamera(75,$('.main-block').width()/$('.main-block').height(),0.1,1000);
camera.position.z = 130;
var controls = new THREE.OrbitControls(camera);
controls.dispose(); // disable controls
controls.autoRotate = true;
controls.enablePan = false;
controls.enableKeys = false;

// Setup raycaster
var raycaster = new THREE.Raycaster();

// Track mouse
var mouse = new THREE.Vector2();
function onMouseMove(event) {
    mouse.x = (event.clientX/$('.main-block').width())*2-1;
    mouse.y = -(event.clientY/$('.main-block').height())*2+1;
}
window.addEventListener('mousemove',onMouseMove,false);

// load geometries
var loader = new THREE.JSONLoader();
var left_pial; var right_pial;
loader.load(
    "https://cdn.rawgit.com/vanandrew/dglabsite/greene/static/dlabsite/js/left_pial.json",
    function(geometry) {
        left_pial = geometry;
        scene.add(new THREE.Mesh(left_pial,new THREE.MeshLambertMaterial({vertexColors:THREE.VertexColors})));
        loader.load(
            "https://cdn.rawgit.com/vanandrew/dglabsite/greene/static/dlabsite/js/right_pial.json",
            function(geometry) {
                right_pial = geometry;
                scene.add(new THREE.Mesh(right_pial,new THREE.MeshLambertMaterial({vertexColors:THREE.VertexColors})));
                render_loop();
            },
            function(xhr) {},
            function(err) { console.log(err); }
        );
    },
    function(xhr) {},
    function(err) { console.log(err); }
);

function render_loop() {
    // Render loop
    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        render();
    }
    animate();
}

// Render function
function render() {
    raycaster.setFromCamera(mouse,camera);
    var intersects = raycaster.intersectObjects(scene.children);
    try {
        var facecolor = intersects[0].face.vertexColors[0];
        var red = Math.round(facecolor['r']*255);
        var green = Math.round(facecolor['g']*255);
        var blue = Math.round(facecolor['b']*255);
        var region = colortable[red][green][blue].replace('ctx-lh-','').replace('ctx_lh_','');
        $('.region-display').html(region);
    }
    catch (err) {}
    renderer.render(scene,camera);
}
// render background first
render();

// resize renderer and camera on window resize
$(window).resize(function() {
    camera.aspect = $('.main-block').width()/$('.main-block').height();
    camera.updateProjectionMatrix();
    renderer.setSize($('.main-block').width(),$('.main-block').height());
});

// enable/controls on click
var state = 0;
$('.region-display').hide();
$("#interact").click(function(){
    if (state == 0) {
        $("#interact").html('back');
        $('.title-text').hide();
        $('.region-display').show();
        controls.autoRotate = false;
        controls.startagain();
        state = 1;
    }
    else if (state == 1) {
        $("#interact").html('interact');
        $('.title-text').show();
        $('.region-display').hide();
        controls.dispose();
        state = 0;
    }
});
</script>
{% endblock %}
